# üî• Documenta√ß√£o - Sistema de Aquecimento de Chips

## üåü Vis√£o Geral

O Sistema de Aquecimento de Chips √© uma funcionalidade avan√ßada para simular conversa√ß√µes naturais com contatos, mantendo os n√∫meros WhatsApp "aquecidos" e saud√°veis. O sistema permite criar campanhas automatizadas que enviam mensagens de forma inteligente e controlada.

## üéØ Funcionalidades Principais

### ‚ú® Recursos Implementados

- **üìã Campanhas de Aquecimento**: Cria√ß√£o e gerenciamento de campanhas
- **üì± M√∫ltiplas Sess√µes**: Suporte a v√°rias sess√µes WhatsApp por campanha
- **üë• Gerenciamento de Contatos**: Sele√ß√£o de contatos espec√≠ficos para aquecimento
- **üí¨ Templates de Mensagem**: Sistema de templates com personaliza√ß√£o
- **üìÅ Arquivos de M√≠dia**: Upload e gerenciamento de imagens, √°udios e documentos
- **‚è∞ Agendamento Inteligente**: Controle de hor√°rios e intervalos
- **üé≤ Aleatoriza√ß√£o**: Randomiza√ß√£o de mensagens e intervalos
- **üìä Sa√∫de do N√∫mero**: C√°lculo autom√°tico da sa√∫de baseado em m√©tricas
- **üìà Estat√≠sticas**: Relat√≥rios detalhados de performance
- **üîÑ Execu√ß√£o Autom√°tica**: Sistema de cron jobs para processamento

---

## üîê Autentica√ß√£o

Todos os endpoints requerem autentica√ß√£o via Bearer Token.

```bash
Authorization: Bearer <access_token>
```

---

## üìã Endpoints das Campanhas

### 1. ‚ûï Criar Campanha

**Endpoint:** `POST /warmup/campaigns`  
**Permiss√£o:** `CREATE_WARMUP_CAMPAIGNS`

#### Request Body
```typescript
{
  name: string;                    // Nome da campanha
  description?: string;            // Descri√ß√£o opcional
  dailyMessageGoal?: number;       // Meta di√°ria (padr√£o: 50)
  minIntervalMinutes?: number;     // Intervalo m√≠nimo (padr√£o: 30)
  maxIntervalMinutes?: number;     // Intervalo m√°ximo (padr√£o: 180)
  workingHourStart?: number;       // Hora in√≠cio (padr√£o: 8)
  workingHourEnd?: number;         // Hora fim (padr√£o: 18)
  useWorkingHours?: boolean;       // Usar hor√°rio comercial (padr√£o: true)
  allowWeekends?: boolean;         // Permitir fins de semana (padr√£o: false)
  randomizeMessages?: boolean;     // Aleatorizar mensagens (padr√£o: true)
  randomizeInterval?: boolean;     // Aleatorizar intervalos (padr√£o: true)
  sessionIds?: string[];           // IDs das sess√µes
  contactIds?: string[];           // IDs dos contatos
}
```

#### Exemplo de Requisi√ß√£o
```bash
POST /warmup/campaigns
Content-Type: application/json

{
  "name": "Aquecimento Vendas",
  "description": "Campanha para aquecimento dos n√∫meros de vendas",
  "dailyMessageGoal": 80,
  "minIntervalMinutes": 45,
  "maxIntervalMinutes": 120,
  "workingHourStart": 9,
  "workingHourEnd": 17,
  "useWorkingHours": true,
  "allowWeekends": false,
  "randomizeMessages": true,
  "randomizeInterval": true,
  "sessionIds": ["session_123", "session_456"],
  "contactIds": ["contact_abc", "contact_def"]
}
```

#### Resposta de Sucesso (201)
```json
{
  "id": "warmup_123",
  "name": "Aquecimento Vendas",
  "description": "Campanha para aquecimento dos n√∫meros de vendas",
  "isActive": true,
  "dailyMessageGoal": 80,
  "minIntervalMinutes": 45,
  "maxIntervalMinutes": 120,
  "workingHourStart": 9,
  "workingHourEnd": 17,
  "useWorkingHours": true,
  "allowWeekends": false,
  "randomizeMessages": true,
  "randomizeInterval": true,
  "createdAt": "2025-08-18T19:30:00.000Z",
  "updatedAt": "2025-08-18T19:30:00.000Z",
  "organizationId": "org_123",
  "createdById": "user_123",
  "createdBy": {
    "id": "user_123",
    "name": "Jo√£o Admin",
    "email": "joao@empresa.com"
  },
  "campaignSessions": [
    {
      "id": "camp_session_123",
      "sessionId": "session_123",
      "isActive": true,
      "healthScore": 100.0,
      "session": {
        "id": "session_123",
        "name": "WhatsApp Vendas 1",
        "phone": "5511999999999",
        "status": "CONNECTED"
      }
    }
  ],
  "campaignContacts": [
    {
      "id": "camp_contact_123",
      "contactId": "contact_abc",
      "priority": 1,
      "contact": {
        "id": "contact_abc",
        "name": "Maria Silva",
        "phone": "5511888888888"
      }
    }
  ],
  "_count": {
    "campaignSessions": 2,
    "campaignContacts": 5,
    "messageTemplates": 0,
    "executions": 0
  }
}
```

### 2. üìú Listar Campanhas

**Endpoint:** `GET /warmup/campaigns`  
**Permiss√£o:** `READ_WARMUP_CAMPAIGNS`

#### Resposta de Sucesso (200)
```json
[
  {
    "id": "warmup_123",
    "name": "Aquecimento Vendas",
    "description": "Campanha para aquecimento dos n√∫meros de vendas",
    "isActive": true,
    "dailyMessageGoal": 80,
    "createdAt": "2025-08-18T19:30:00.000Z",
    "createdBy": {
      "id": "user_123",
      "name": "Jo√£o Admin",
      "email": "joao@empresa.com"
    },
    "_count": {
      "campaignSessions": 2,
      "campaignContacts": 5,
      "messageTemplates": 3,
      "executions": 150
    }
  }
]
```

### 3. üëÅÔ∏è Obter Campanha Espec√≠fica

**Endpoint:** `GET /warmup/campaigns/:id`  
**Permiss√£o:** `READ_WARMUP_CAMPAIGNS`

#### Resposta de Sucesso (200)
```json
{
  "id": "warmup_123",
  "name": "Aquecimento Vendas",
  "campaignSessions": [
    {
      "id": "camp_session_123",
      "sessionId": "session_123",
      "isActive": true,
      "healthScore": 87.5,
      "dailyMessagesSent": 45,
      "totalMessagesSent": 320,
      "session": {
        "id": "session_123",
        "name": "WhatsApp Vendas 1",
        "phone": "5511999999999",
        "status": "CONNECTED"
      },
      "healthMetrics": [
        {
          "date": "2025-08-18",
          "messagesSent": 45,
          "messagesDelivered": 43,
          "messagesRead": 38,
          "responsesReceived": 12,
          "averageMessagesPerHour": 5.6,
          "healthScore": 87.5
        }
      ]
    }
  ],
  "messageTemplates": [
    {
      "id": "template_123",
      "content": "Oi {nome}! {saudacao}, tudo bem?",
      "messageType": "text",
      "weight": 3,
      "isActive": true
    }
  ],
  "executions": [
    {
      "id": "exec_123",
      "messageContent": "Oi Maria! Bom dia, tudo bem?",
      "messageType": "text",
      "status": "delivered",
      "scheduledAt": "2025-08-18T10:30:00.000Z",
      "sentAt": "2025-08-18T10:30:15.000Z",
      "session": {
        "id": "session_123",
        "name": "WhatsApp Vendas 1"
      },
      "contact": {
        "id": "contact_abc",
        "name": "Maria Silva",
        "phone": "5511888888888"
      }
    }
  ]
}
```

### 4. ‚úèÔ∏è Atualizar Campanha

**Endpoint:** `PATCH /warmup/campaigns/:id`  
**Permiss√£o:** `UPDATE_WARMUP_CAMPAIGNS`

#### Request Body
```typescript
{
  name?: string;
  description?: string;
  dailyMessageGoal?: number;
  minIntervalMinutes?: number;
  maxIntervalMinutes?: number;
  workingHourStart?: number;
  workingHourEnd?: number;
  useWorkingHours?: boolean;
  allowWeekends?: boolean;
  randomizeMessages?: boolean;
  randomizeInterval?: boolean;
  isActive?: boolean;
}
```

### 5. üóëÔ∏è Deletar Campanha

**Endpoint:** `DELETE /warmup/campaigns/:id`  
**Permiss√£o:** `DELETE_WARMUP_CAMPAIGNS`

#### Resposta de Sucesso (200)
```json
{
  "message": "Campanha removida com sucesso"
}
```

---

## üì± Gerenciamento de Sess√µes

### 6. ‚ûï Adicionar Sess√µes √† Campanha

**Endpoint:** `POST /warmup/campaigns/:id/sessions`  
**Permiss√£o:** `UPDATE_WARMUP_CAMPAIGNS`

#### Request Body
```typescript
{
  sessionIds: string[];  // Array de IDs das sess√µes
}
```

#### Exemplo de Requisi√ß√£o
```bash
POST /warmup/campaigns/warmup_123/sessions
Content-Type: application/json

{
  "sessionIds": ["session_789", "session_101"]
}
```

### 7. ‚ùå Remover Sess√£o da Campanha

**Endpoint:** `DELETE /warmup/campaigns/:id/sessions/:sessionId`  
**Permiss√£o:** `UPDATE_WARMUP_CAMPAIGNS`

---

## üë• Gerenciamento de Contatos

### 8. ‚ûï Adicionar Contatos √† Campanha

**Endpoint:** `POST /warmup/campaigns/:id/contacts`  
**Permiss√£o:** `UPDATE_WARMUP_CAMPAIGNS`

#### Request Body
```typescript
{
  contactIds: string[];    // Array de IDs dos contatos
  priority?: number;       // Prioridade (1-5, padr√£o: 1)
}
```

#### Exemplo de Requisi√ß√£o
```bash
POST /warmup/campaigns/warmup_123/contacts
Content-Type: application/json

{
  "contactIds": ["contact_xyz", "contact_123"],
  "priority": 3
}
```

### 9. ‚ùå Remover Contato da Campanha

**Endpoint:** `DELETE /warmup/campaigns/:id/contacts/:contactId`  
**Permiss√£o:** `UPDATE_WARMUP_CAMPAIGNS`

---

## üí¨ Templates de Mensagem

### 10. ‚ûï Criar Template

**Endpoint:** `POST /warmup/campaigns/:id/templates`  
**Permiss√£o:** `UPDATE_WARMUP_CAMPAIGNS`

#### Request Body
```typescript
{
  content: string;           // Conte√∫do da mensagem
  messageType?: string;      // 'text', 'image', 'audio', 'document'
  weight?: number;           // Peso para sele√ß√£o (1-10, padr√£o: 1)
  variables?: object;        // Vari√°veis customizadas
}
```

#### Exemplo de Requisi√ß√£o
```bash
POST /warmup/campaigns/warmup_123/templates
Content-Type: application/json

{
  "content": "{saudacao} {nome}! Como voc√™ est√°? Espero que esteja tudo bem por a√≠!",
  "messageType": "text",
  "weight": 5,
  "variables": {
    "customVar": "valor"
  }
}
```

#### Vari√°veis Dispon√≠veis
- `{nome}`: Nome do contato
- `{telefone}`: Telefone do contato
- `{email}`: Email do contato
- `{saudacao}`: Sauda√ß√£o autom√°tica baseada no hor√°rio (Bom dia/Boa tarde/Boa noite)

### 11. ‚úèÔ∏è Atualizar Template

**Endpoint:** `PATCH /warmup/campaigns/:id/templates/:templateId`  
**Permiss√£o:** `UPDATE_WARMUP_CAMPAIGNS`

### 12. üóëÔ∏è Deletar Template

**Endpoint:** `DELETE /warmup/campaigns/:id/templates/:templateId`  
**Permiss√£o:** `UPDATE_WARMUP_CAMPAIGNS`

---

## üìÅ Arquivos de M√≠dia

### 13. üì§ Upload de Arquivo

**Endpoint:** `POST /warmup/campaigns/:id/media`  
**Permiss√£o:** `UPDATE_WARMUP_CAMPAIGNS`  
**Content-Type:** `multipart/form-data`

#### Request Body
- `file`: Arquivo de m√≠dia (m√°ximo 10MB)

#### Tipos Suportados
- **Imagens**: JPG, PNG, GIF, WebP
- **√Åudios**: MP3, WAV, OGG
- **V√≠deos**: MP4, AVI, MOV
- **Documentos**: PDF, DOC, DOCX

#### Exemplo de Requisi√ß√£o
```bash
POST /warmup/campaigns/warmup_123/media
Content-Type: multipart/form-data

--boundary
Content-Disposition: form-data; name="file"; filename="audio.mp3"
Content-Type: audio/mpeg

[binary data]
--boundary--
```

#### Resposta de Sucesso (201)
```json
{
  "id": "media_123",
  "campaignId": "warmup_123",
  "fileName": "audio.mp3",
  "filePath": "./uploads/warmup/abc123.mp3",
  "fileType": "audio",
  "fileSize": 1024000,
  "mimeType": "audio/mpeg",
  "isActive": true,
  "createdAt": "2025-08-18T19:45:00.000Z"
}
```

---

## üìä Estat√≠sticas e Sa√∫de

### 14. üìà Estat√≠sticas da Campanha

**Endpoint:** `GET /warmup/campaigns/:id/stats`  
**Permiss√£o:** `READ_WARMUP_CAMPAIGNS`

#### Resposta de Sucesso (200)
```json
{
  "campaign": {
    "id": "warmup_123",
    "name": "Aquecimento Vendas",
    "isActive": true
  },
  "stats": {
    "totalExecutions": 450,
    "successfulExecutions": 425,
    "successRate": 94.4,
    "averageHealthScore": 87.3,
    "totalSessions": 3,
    "activeSessions": 3
  },
  "sessions": [
    {
      "id": "camp_session_123",
      "sessionId": "session_123",
      "sessionName": "WhatsApp Vendas 1",
      "phone": "5511999999999",
      "healthScore": 89.2,
      "dailyMessagesSent": 28,
      "totalMessagesSent": 156,
      "isActive": true,
      "lastHealthUpdate": "2025-08-18"
    }
  ]
}
```

### 15. üîÑ Calcular Sa√∫de do N√∫mero

**Endpoint:** `POST /warmup/campaigns/:id/sessions/:sessionId/health`  
**Permiss√£o:** `READ_WARMUP_CAMPAIGNS`

#### Resposta de Sucesso (200)
```json
{
  "campaignSessionId": "camp_session_123",
  "sessionId": "session_123",
  "healthScore": 87.5,
  "calculatedAt": "2025-08-18T19:50:00.000Z"
}
```

## üßÆ C√°lculo da Sa√∫de do N√∫mero

A sa√∫de do n√∫mero √© calculada com base em m√∫ltiplas m√©tricas dos √∫ltimos 7 dias:

### üìä M√©tricas Consideradas

1. **Taxa de Entrega (30%)**: Mensagens entregues / Mensagens enviadas
2. **Taxa de Leitura (20%)**: Mensagens lidas / Mensagens entregues  
3. **Taxa de Resposta (25%)**: Respostas recebidas / Mensagens enviadas
4. **Velocidade de Envio (25%)**: Mensagens por hora (ideal: 2-8 msg/hora)

### üéØ Pontua√ß√£o
- **90-100**: Excelente üü¢
- **75-89**: Boa üü°  
- **60-74**: Regular üü†
- **0-59**: Ruim üî¥

---

## ‚öôÔ∏è Sistema Autom√°tico

### üîÑ Processamento Autom√°tico

O sistema executa automaticamente a cada 5 minutos, verificando:

1. **Campanhas Ativas**: Apenas campanhas com `isActive: true`
2. **Hor√°rio Permitido**: Respeita configura√ß√µes de hor√°rio comercial
3. **Limite Di√°rio**: Verifica meta di√°ria de mensagens
4. **Intervalos**: Respeita intervalos m√≠nimos/m√°ximos
5. **Aleatoriza√ß√£o**: Aplica randomiza√ß√£o quando configurada

### üìã Fluxo de Execu√ß√£o

1. Buscar campanhas ativas
2. Para cada sess√£o da campanha:
   - Verificar limite di√°rio
   - Verificar intervalo desde √∫ltima mensagem
   - Selecionar contato aleat√≥rio (baseado em prioridade)
   - Selecionar template aleat√≥rio (baseado em peso)
   - Agendar mensagem com personaliza√ß√£o
   - Atualizar contadores

---

## üö® C√≥digos de Erro

| C√≥digo | Descri√ß√£o | Exemplo |
|--------|-----------|---------|
| 400 | Bad Request | Dados de entrada inv√°lidos |
| 401 | Unauthorized | Token inv√°lido ou expirado |
| 403 | Forbidden | Sem permiss√£o para a opera√ß√£o |
| 404 | Not Found | Campanha/Template n√£o encontrado |
| 409 | Conflict | Sess√£o j√° adicionada √† campanha |
| 413 | Payload Too Large | Arquivo muito grande (>10MB) |
| 422 | Unprocessable Entity | Arquivo de tipo n√£o suportado |
| 500 | Internal Server Error | Erro interno do servidor |

---

## üí° Exemplos de Uso

### üéØ Cen√°rio 1: Campanha B√°sica

```bash
# 1. Criar campanha simples
POST /warmup/campaigns
{
  "name": "Aquecimento B√°sico",
  "dailyMessageGoal": 30,
  "sessionIds": ["session_123"],
  "contactIds": ["contact_abc", "contact_def"]
}

# 2. Adicionar templates
POST /warmup/campaigns/{id}/templates
{
  "content": "Oi {nome}! {saudacao}, tudo bem?",
  "weight": 3
}

POST /warmup/campaigns/{id}/templates
{
  "content": "E a√≠ {nome}! Como est√° o seu dia?",
  "weight": 2
}
```

### üéØ Cen√°rio 2: Campanha Avan√ßada

```bash
# 1. Criar campanha com configura√ß√µes avan√ßadas
POST /warmup/campaigns
{
  "name": "Aquecimento VIP",
  "description": "Aquecimento para clientes VIP",
  "dailyMessageGoal": 60,
  "minIntervalMinutes": 60,
  "maxIntervalMinutes": 240,
  "workingHourStart": 9,
  "workingHourEnd": 18,
  "allowWeekends": false,
  "randomizeMessages": true,
  "randomizeInterval": true,
  "sessionIds": ["session_123", "session_456"],
  "contactIds": ["contact_vip1", "contact_vip2"]
}

# 2. Upload de arquivo de √°udio
POST /warmup/campaigns/{id}/media
Content-Type: multipart/form-data
[audio file]

# 3. Verificar estat√≠sticas
GET /warmup/campaigns/{id}/stats
```

---

## üìù Notas Importantes

1. **üîÑ Processamento**: O sistema processa automaticamente a cada 5 minutos
2. **‚è∞ Hor√°rios**: Respeita configura√ß√µes de hor√°rio comercial e fins de semana
3. **üé≤ Aleatoriza√ß√£o**: Mensagens e intervalos podem ser randomizados
4. **üìä Sa√∫de**: C√°lculo autom√°tico baseado em m√∫ltiplas m√©tricas
5. **üîí Permiss√µes**: Sistema completo de controle de acesso
6. **üìÅ Arquivos**: Suporte a m√∫ltiplos tipos de m√≠dia
7. **üè∑Ô∏è Vari√°veis**: Sistema de personaliza√ß√£o de mensagens
8. **üìà M√©tricas**: Coleta autom√°tica de dados para an√°lise

---

**Documenta√ß√£o criada em**: 18/08/2025  
**Vers√£o**: 1.0.0  
**Sistema**: Aquecimento de Chips WhatsApp
